
using Polynomials4ML, ACEbase, Printf, ACEpsi, Random, Test
# using ACEpsi: BFwf1, gradient, laplacian, displayspec
# using ACEpsi: envelopefcn
using LinearAlgebra
using ACEpsi: BFwf1dps_lux, setupBFState, displayspec
using ACEpsi.vmc: gradient, laplacian, grad_params, MHSampler, rq_MC, grad, d1, d1_lattice, SumH, grad
import ACEpsi.vmc: sampler_restart, sampler, Eloc_Exp_TV_clip, Elocal
using SpecialFunctions
using LuxCore
using Lux
using Zygote
using JLD 
using Distributed
using Statistics
##

# jellium set up
Nel = 30
rs = 1 # Wigner-Seitz radius r_s for 1D = 1/(2ρ); where ρ = N/L
ρ = 1 / (2 * rs) # (average density)
L = Nel / ρ # supercell size

Σ = rand(spins(), Nel)
# paramagnetic 
for i = 1:Int(Nel / 2)
   Σ[i] = ↑
   Σ[Int(Nel / 2)+i] = ↓
end

# basis, trans
totdegree = [34]
ord = length(totdegree)
Pn = Polynomials4ML.RTrigBasis(maximum(totdegree)+ord)
trans = x -> 2*pi*x/L


# lux wf
_get_ord = bb -> sum([bb[i].n .!= 1 for i = 1:length(bb)]) == 0 ? 1 : sum([bb[i].n .!= 1 for i = 1:length(bb)])
sd_admissible_func(ord,Deg) = bb -> (all([length(bb) == ord]) # must be of order ord, and 
                                    && (all([sum([bb[i].n .!= 1 for i = 1:length(bb)]) == 0]) # all of the basis in bb must be (1, σ)
                                        || all([sum([bb[i].n for i = 1:length(bb)]) <= Deg[_get_ord(bb)] + ord])) # if the degree of the basis is less then the maxdegree, "+ ord" since we denote degree 0 = 1
                                        && (bb[1].s == '∅') # ensure b=1 are of empty spin
                                        && all([b.s != '∅' for b in bb[2:end]])) # ensure b≠1 are of of non-empty spin
sd_admissible = sd_admissible_func(ord,totdegree[1])

wf_new, spec_new, spec1p_new = BFwf1dps_lux(Nel, Pn; ν = ord, trans = trans,  totdeg = totdegree[1], sd_admissible = sd_admissible)
ps, st = setupBFState(MersenneTwister(1234), wf_new, Σ)

# wf_new(X, ps, st)

# the spec between old and new should match up. At the moement, they should both be UHF
displayspec(spec_new, spec1p_new)

## Using same parameters\weights for both old and new
### Random orthogonal weights
# Q, _ = qr(randn(length(spec_new), Nel))
# W1 = Matrix(Q)'

### weights from ACESchrodinger computation
W1 = [-0.788121906453869 -0.9686871471978082 -0.5229278483766919 0.5911901916152552 0.27374035512546235 0.047892716579161734 -0.2441116933545812 -0.45471357328917994 0.04792276891665541 -0.31823899075342515 0.025444637314092643 0.22611761446760759 0.026001234073844918 -0.11316944687160425 0.05814911309315611 0.14156610790589538 0.23262842607456444 0.1180206090793362 0.09412068973716918 0.022608999077670663 -0.03282873248533994 0.008414049077739521 0.0003143623808858787 -0.019128635891973396 -0.01605709369138279 0.04719518045443358 0.07162552487814336 -0.007398433235337477 -0.029900500379057 -0.027409562653348245 -0.03376662352203947 -0.06960399226500649 -0.0067600569518972056 0.026115591672341846 0.0021388843918155724; 
0.35223047875112334 0.010550908864019293 -0.028864066401709316 0.35377770337939685 0.36822529069406207 -0.27440558672041737 0.16329085120686565 -0.10072333789665325 0.6324610766836892 0.6137288101119107 0.14963708531621184 0.1205256794336406 -0.24157008842182304 0.37209755259703703 -0.05676425812746879 0.23806596736941668 -0.03164796804032903 0.005670434741933756 -0.1372884061968589 -0.04214032373410323 0.027701614983456038 0.044450477631523204 0.025833461792603922 0.055154523896631974 -0.03599202037568094 -0.032333384795197116 -0.01880193273592226 0.02978538630495267 -0.03875946141368357 -0.02707211235482066 -0.013561339746775805 0.012406297460508635 -4.685079906080399e-5 0.02938264114234001 0.06576209304010076; 
-0.309310934509335 0.2841496457956035 -0.6169112896944011 0.14182871103502945 -0.6421844327886438 -1.1103462610711479 0.5341693858233683 0.15263007840411014 0.07251053591854034 0.024932409461924872 -0.0725744518875139 0.08808997774072265 0.2887495663811482 -0.061903999624817775 0.18942008858761172 0.07615605991657666 0.028797604121873176 0.07943657257886802 0.011677127603559467 -0.01653668150169557 -0.06107479743845744 0.00573403320932999 -0.017343724006812784 0.0005638834557644381 0.09398524458596387 0.010344462718010369 0.0029240668975997553 0.04030398278123115 -0.018837002522427846 0.011859172254407562 -0.0065447669239568134 -0.027255354966003488 0.010584469607783286 0.026838133193392424 -0.005114991230127205; 
-0.36767090629319804 0.4027006573123526 -0.1614185917689738 -0.279058570153344 -0.10237300604630321 0.5077984251614515 0.5043695167792276 -0.002103490877869502 0.1814531998250313 -0.11773314766774984 0.4851247060292147 0.35233293962955636 0.37913606690619717 0.36709054511934586 -0.044934493818785115 0.35976634758615406 0.002945968975732411 0.13514874774942806 -0.18407969496999244 0.025154630150568583 -0.05640538828679163 0.028515673475008357 0.009778730957452719 0.02988170959407965 0.08381455876406026 0.009572504006421923 -0.012690479308412859 0.050902126090715615 0.06806934450250207 -0.0464611984529329 -0.0031576583572921115 -0.027864360878276994 -0.029399988065715033 -0.016128482690025092 0.04490728668302813; 
-0.3970769079995029 -0.2734825085457551 0.5413129987276301 0.48288611765301254 -0.3811620670651731 0.2514005134168321 0.7966840759268013 -0.0233153872895148 -0.239636183731034 0.41820529074069696 0.14655338039857918 0.06601135941159152 0.04034985920351501 -0.21256425055076003 0.13742784682430267 0.0019020375904970073 0.17815665434673206 0.10080020433185337 0.07225557574449053 0.05730274712771817 -0.0712024160167404 -0.03593642283375069 0.05187781887317728 -0.03229109071305515 0.01722209489562944 0.03728254335231611 -0.014609687450860116 0.010171055713608507 -0.02369539644459667 -0.02668919358042826 -0.012353790166201577 -0.02947365107695411 -0.006730748447519605 -0.03924499164458353 0.008009035074072735; 
-0.4023624255245919 -0.30265437937184897 0.18173233641597566 0.15931612259624997 0.22118925486550164 -0.6413461262328631 -0.08494348576441292 -0.07023671674136432 -0.2037408841771677 0.046112716928057254 0.5358879973695323 -0.22379477492554792 0.34003679569554685 0.17296143555773216 -0.38077082726693384 -0.38124344862906134 -0.3831427970964287 -0.22691233491128507 0.11990442997499516 -0.04767697559285309 -0.028039985595690535 -0.029000214899637673 -0.008628201941240726 0.01316243004295837 0.049692414631984115 -0.003152545516615873 0.07681031602562545 -0.027865770113561467 0.02466841325423223 -0.00463062429799038 0.0011415894215580633 -0.00996313108691329 -0.024199239437181976 0.005058878394873916 -0.01454024121479412; 
-0.7594537938468773 0.25482611458386906 -0.2937370771454011 -0.01652117245916191 -0.3768819888488184 0.3094420802494699 0.20455360789531987 0.4593127071865092 0.5182067589068408 0.07497484418457741 -0.5673804579701581 -0.03946034656923708 -0.22256719157236862 -0.01814046034659035 -0.5173177172088242 0.024062175910676557 0.024104706365920527 0.1594476980991948 -0.039179786764661086 0.045592101871173706 -0.10116835805428424 0.0028624749442556956 -0.02008885707446951 0.001530868887030137 0.059451969101822114 -0.10738253098951107 -0.03560785486709329 0.03759848653270346 0.027840982943249555 0.04874786161693232 0.021213493463222183 0.006890611806062641 -0.012525078455198834 -0.03845225478793585 -0.06202119313019081; 
0.0734480961508846 0.525954156748519 -0.26946041978185364 0.5035837356642563 -0.8440116610661045 0.0036391031349430085 -0.2832307055653431 -0.517812954012786 -0.4090517642232043 -0.029040288925637144 -0.11844264138231056 0.11869174763884073 -0.2674447256192016 -0.07014546244126876 -0.5637123966607319 0.1635601277987268 -0.046303429829436325 -0.029097962035269865 -0.13647539933918215 -0.060839957067679834 -0.04762753279928556 0.04951631421759366 0.0009252963154968456 -0.017538690480157135 -0.008530701314224013 -0.019979677491559635 -0.013421262498418204 -0.0032021567793831633 -0.0018904541720731545 0.03523884164197208 0.005399603069104555 -0.006346840127004321 0.012030110316288716 -0.0458934934415226 -0.017816032290294152; 
-0.050609465917696106 0.8732686220195711 0.008829487648561611 0.9141032233771721 0.6096256404296859 -0.041172154976660234 0.3301624788554789 0.26039554696382283 -0.0797253762842305 -0.3165997146762994 -0.05099352039763023 0.03910679391599302 0.13427768815433483 -0.08034482693140656 0.029039335453890217 0.07839895867626158 0.02337217786576466 0.00519281245428255 -0.010813708804437137 0.028300718184622094 -0.0584013836390315 -0.006955344070383937 -0.02405000175159441 -0.02499813394112938 0.0015986569140839617 0.000837134397942949 -0.04099381845711514 -0.017094218382932676 0.06507781624380418 -0.013589385589450078 -0.0069593695152998895 0.028056289561598943 -0.015477313248732465 -0.024550679316460242 -0.03572373662065237; 
0.17503565584413033 0.014173492588482483 0.5700420817288343 -0.18061702107307753 -0.11547182647171728 -0.24284766500875124 0.7682624744882326 -0.5038296930393045 0.3599999371573851 -0.8523947703274948 -0.10294869206249671 -0.4734875890091171 -0.10735369454179226 -0.07019870263028236 -0.30276200892313343 0.05439725204653876 -0.23357964659386443 0.007778205179818964 -0.0410616336867138 0.014930738160090464 -0.08705047574927645 -0.05756240946648338 0.026203759164614312 -0.03003579924391053 0.006028609654864353 -0.014153132576124078 -0.0025071550812890576 0.03817730885249597 0.04475755825961176 0.02021071426583039 -0.004731136586138429 -0.007567979448898593 0.0015545281286002892 -0.0172326774371801 -0.038769025109859356; 
0.05865594082090031 0.15264623896500704 0.15861207424008783 0.25190174189172576 -0.0947117049064497 0.23654070454555612 -0.22404793207394505 -0.328179855334053 0.7834065672397058 0.2015927800391747 -0.10847169067404355 0.45591949240931595 0.5287290155614184 -0.2861288485159238 0.049376847030216685 -0.333732723868345 0.28898749309720057 0.14228025466423064 0.19166891506444003 0.05279590675947059 0.017426466460502527 0.006951417016232474 -0.051602239988440636 0.0131358941629983 0.061370049566825305 -0.041778514745295765 -0.034469725093716104 0.07703099263801878 -0.04472758037767434 -0.008104202409424777 -0.009754485490944279 0.003865789351767112 0.027683415286828432 -0.003299709740098975 -0.02252519119952534; 
-0.12708805633168874 0.354281426784929 -0.6924100098004116 0.29059222207011004 -0.008202841252556324 0.38371197964234116 0.23547985814774738 -0.4814191303036629 0.20009316124623994 0.3370864407324091 0.03331804323988026 -0.5695096232700967 -0.03052947513679946 -0.0971785911222888 0.33599061681597325 -0.05261872126775092 -0.03921182510814576 -0.353726250520682 0.09466865480038686 0.006890767490790383 0.2219999472678893 0.03012501834985391 0.012730674466089293 0.0022674344054383093 -0.06541676737219133 -0.018410742309364677 -0.0408665164278386 0.04549614319890329 0.0179508339338844 0.016707889969062903 -0.016545491564579583 0.019296294455574372 0.0727519358115362 -0.04795584544161182 0.02544650998168966; 
-0.3103818284068614 0.3492653698032897 -0.15069794222781913 -0.38624831730258563 0.37367122656742907 -0.3015219867465785 -0.04878389021868555 -0.06636827492364195 0.04802835882627406 -0.04086594550472093 0.602425092377666 0.2975987056724963 -0.5437433772924255 -0.4744637716324009 0.02288423901320661 -0.09964197662762031 0.1322732556614707 0.005234891877773315 0.07087739674334932 -0.06845952055630825 -0.0024787022822698457 0.03995536948977472 0.03552815150860719 0.01822613315737882 0.07282514354411522 0.023613192899496368 0.03306650245318505 -0.024489147110652594 -0.03615877444638383 -0.02344240955157949 0.029399869277538425 -0.08254470907967551 0.008800996405825563 0.03956225368504186 0.0016269088248238757; 
-0.4582806645620176 0.41000118880035663 0.6660979190127833 -0.35834636236052886 -0.09535776497621616 -0.47599114355803807 -0.4826267452385846 -0.35287292826994754 -0.1510638848232702 0.27676416608968535 -0.06385746489314649 -0.23462748783763865 -0.09914831504702784 0.2334370174056795 0.47649750472183555 0.27921575698920714 0.06027361056768111 0.11485251225428081 -0.04367039376014114 0.03401319894026147 -0.04685936876859303 0.038990694056424954 0.03685389962930708 -0.0017491987043476672 0.04875116596755445 -0.016442006576068688 0.023767063509935606 -0.009485867657405028 0.013579668725561767 -0.013158966960015943 -0.02697170982600079 -0.02631452305563 0.013457907408930407 0.0043880102673511095 0.014480774766430185; 
0.06732693811378473 0.17207774917885066 -0.1454540609909314 -0.2726793279622963 0.6760310281527452 -0.20596138128897215 0.3890417925360824 -0.6697913999399107 -0.5464407395760243 0.33363385521201094 -0.670303119387826 0.22200351614427635 0.018529236252450246 -0.06570372140832868 -0.29318453279659124 -0.09966771565148606 -0.048483141776494175 -0.004715762653605784 -0.08885316335443935 -0.0058661857862713895 -0.0024631386972146893 -0.05473577865836976 -0.01765566168342645 -0.005170955897948313 0.0519430505361956 -0.028259698569657866 -0.022279111173033887 -0.046984572105147955 -0.022163573945767158 0.020366888982016218 0.03203640047090415 0.0051588322904094685 0.03206182437949866 0.01760121348848528 -0.022364666515837878; 
-0.6185020632229583 -0.02978997445768995 0.5963367185522644 0.28307016184015404 0.8745790932597891 -0.07225562555507842 -0.31467564803512904 -1.0408810180053878 -0.16594575330225542 0.6466306215868239 0.28085788904101494 -0.48327447305881627 0.5159532122775035 0.214982060241273 -0.04815888045494332 -0.020108718320559396 0.17370901029523592 0.05629279109945128 -0.03535609907380282 -0.026190583113389704 0.012689568615215167 0.013415228073048154 0.04651453756705583 0.08536806230607683 0.016993605308667756 -0.05599928972555999 0.001086656636726078 0.03162359355918183 -0.0030813555989057584 0.010889521021450993 -0.032237787378001745 -0.01658275989752504 -0.02601768110028343 -0.0007656986166520671 -0.020349877581086948; 
0.6073635368328076 0.4790000043945898 0.29554895355279587 0.5897433561862386 0.01425851185463377 1.120845433664922 -0.08658187430489774 0.07652433836430068 -0.6040784201472005 0.3627078746952049 0.2931051782565185 -0.23666766830436364 -0.17159649884731515 0.1641261636542941 -0.15530986270475522 -0.1755396549723137 -0.15764939667271458 0.11583968469101409 -0.023257426600330876 0.030396232714553637 -0.017622153821950995 -0.0041816231337436114 0.006904974186954966 0.003191585169622787 -0.012144843443885518 -0.026239391849752474 0.05067509857697439 0.007481655404837409 -0.008643233894375442 -0.018282788854142383 -0.03353880073599943 -0.043624326369486384 0.007740001884153223 -0.012143958236008614 -0.0005397237456483669; 
0.4525529229723703 -0.8297957398463927 0.9348337109296505 0.7360495761310865 0.07860550764952923 -0.39912973446039046 0.1844117344666983 0.09683622939036303 0.19062591865653702 0.48677536608965016 -0.26712565120536164 0.36670850335134053 -0.2140501629159106 -0.39228765092517953 0.19859006477222269 0.1873444738358803 0.011428995517514591 -0.07861805338184495 0.11800532275963763 0.0016562058817417471 -0.033284459978890485 -0.015571831956443486 0.024070132870171797 -0.01099706239312016 -0.0668014622996282 0.08334506582524509 0.012398044150563498 -0.04836178405300019 -0.06696188304827164 0.01900544182672672 -0.03440504809577938 -0.01520076062058825 0.030902505960201884 -0.08124693272157152 -0.0070857044434564295; 
-0.1535304110596494 -0.35625271476196607 0.39503916480573775 -0.906704142172293 -0.012829282010519388 0.014416531024990756 -0.2812315991619869 -0.08884706052585456 -0.46972899931522166 0.5151760864043613 0.21849127785050768 -0.21531640749010952 -0.9285999420743313 0.052678786008661896 -0.057471661132774174 0.07357286091132004 -0.09420887925972085 0.058122468284924726 -0.03602158427446304 0.010775605833502828 0.005390179586039758 0.06393841923379466 0.05167599795030517 -0.021395815675669907 -0.07177276971901361 0.019843431085488757 -0.00884293703693479 -0.00035754216924416683 -0.018213837956477696 -0.01739175345036028 -0.010791166283488815 0.040990184977349645 0.008078739800035052 -0.031125186569018522 -0.017192652138360562; 
0.1290716764117767 -0.20902372707637656 0.005293326397081674 0.7978153195591418 -0.4261454396581095 -0.45092031679570904 -1.109275093229632 -0.4096724558087736 0.14871433943439055 0.03989129643512369 0.30862404602727156 -0.28200790384201047 -0.12071858386062698 -0.36226680363098085 -0.23586881300770188 0.2834456973660842 -0.25881994894984267 0.10272380309540262 0.10638950288808693 -0.1704823349233394 0.11382895634135398 -0.005593231647848377 -0.022297858173215526 -0.029241360570317225 -0.03486969792107992 0.00353277828967725 -0.027492465756533878 0.012899346980313614 0.0046026163292465175 0.05623179492280295 0.03676623650071291 0.0175031100128472 -0.03881372878784219 0.03207092153771571 0.01718417849197141; 
-0.14830948485696255 0.44231692970587083 0.8977924476217722 -0.028542090919002883 -0.4131013691843456 -0.03806420391993079 -0.12890289049835188 0.1892079141234132 0.2450604434761036 -0.37364545754924205 0.32987410106158843 0.1990713958278456 0.4775394791877327 0.025786282820952126 -0.389845845706486 0.3654894065955769 0.589635731713705 -0.2328373981797493 0.03860987175441061 -0.16845268838161548 -0.08756523775274513 0.017471566546957244 -0.06490483457373082 -0.056866627198338175 0.012016553506394296 -0.050613705753105226 0.031019407903315026 -0.011386930372163314 0.00831013360441756 0.05378088753253869 0.0319682963716959 -0.006958816779167459 -0.062147727333254146 0.03549961999802923 0.03450426772966414; 
0.15985818823888473 0.8334734827726548 -0.28630906913121534 -0.3122157288249418 0.39259407913201777 -0.2575800485649955 0.6463025088161465 -0.214186526616354 -0.05411427545204456 0.2778023366502606 0.4000095289519928 0.09507708566761897 -0.24447417338906305 -0.598378593145793 -0.29646376538019875 0.3349615703259149 -0.3021043741682338 0.07958527012558908 0.14195296954871758 -0.04975006779345346 0.0006132713600237208 0.07943437218873728 -0.0338418388454771 -0.06167647458446133 -0.0561311885049423 -0.010814973974401417 0.0069800962232896115 -0.013233648245844182 0.0334218972574431 -0.0512429040832034 0.012644635052677617 0.0093093354816603 0.015304572315092496 -0.012680663425935441 0.02534434510783055; 
0.19513742653389066 0.6704822899495386 0.20898013957311348 -0.11910012984248368 0.09750293732446404 0.15342039199999138 -0.7910029126479492 -0.2875339417947691 0.8092392900899001 0.5520608886150279 0.1784431711768816 0.2452719367450707 -0.26086765563473174 -0.152737378909988 0.6649671857382793 -0.07216692825015088 -0.05661664092215662 -0.09441629377412286 0.1271258013887748 -0.09265690267703162 -0.07956061469966769 -0.018097429918271353 0.00574902712095393 -0.0367394502570441 0.0015229625147767274 0.008168437007278791 -0.008314916788808564 -0.025256891423339034 0.0353895521889724 0.012466629979260698 0.01287674386443127 0.037192339618527054 -0.0030764781683576027 -0.029353840455968824 0.02496481865720849; 
0.3662501364143399 0.23483683787976092 -0.4204812369177313 0.2821753742400707 0.39927166180503504 -0.3498948730411951 -0.25664651436022784 0.00542859396129861 0.5265623330415665 0.509596479930407 -0.8092794356803207 -0.24651337254199351 -0.4735000485071457 0.26416122446453033 -0.6428665348225643 0.04478728279950822 0.4519220752246127 -0.13742117854540126 0.04587307331357789 -0.06904514469148165 -0.024029059283749852 0.06953282033553741 -0.01469756745744521 -0.015618331316157953 -0.04893512348097206 0.0738026553422503 0.021701020318461918 -0.023520276293850815 -0.014721783701926979 0.07087966094161273 -0.05442845969279332 0.03059573845269128 0.03518746215716536 -0.03492630157054564 -0.04855412794576263; 
0.10365819196480458 0.19992448828739146 0.007813088807502342 0.325576605815533 -0.21452635672785264 0.04895358411371423 -0.15817453157375458 -1.0572085690173672 -0.3432768154316704 -0.6199841905674838 0.331903104744517 0.4138871613710497 -0.49552144404959436 0.15231688965077345 0.19543340938634962 0.19184104875431646 0.047015538774515545 -0.08241923733741698 0.11493331877751772 -0.041633397565309184 -0.10077277901922511 -0.05838738767024235 0.04779183758828841 -0.10361586722554149 -0.0039463955897255385 -0.013268619639630285 -0.05144961156742607 -0.02277776242971021 0.03731848806641346 -0.0017389760123647973 0.013591199796283497 0.02021716843422245 -0.025493707615791464 0.019140920113082785 -0.01967372709888467; 
-0.19849418936422492 -0.2813392691962597 0.03036413549578732 0.07021538736715352 1.3304053885979992 0.44391062633811973 -0.6700819256138508 0.3306634420812016 -0.46496988175986426 -0.6299174990818635 0.1354934240869158 0.17085960030756478 0.03326746117409842 -0.005009401874780009 -0.040579528103307956 -0.0017299631261899274 0.03627234017146643 -0.045232089179953285 0.009169932467854762 0.06533035677632561 -0.011765518665626022 -0.08432931754707604 0.0411735372800671 0.040094585663743985 -0.03519707537412142 0.02089674384820173 -0.002560022919277744 -0.07952355398813235 -0.08638863738863974 0.02087853833332655 0.012066425626664233 -0.019324477153776814 -0.02396378327649209 -0.04326189231288575 -0.009312176218434371; 
-0.4053824263466308 0.14703585844103653 0.6308378796840813 -0.1105942118522814 -0.012620306129203816 0.4836413158986906 0.12744229121459932 -0.12328197891509908 0.27338165754249766 -0.501508017328072 -0.7722109566870613 -0.2371437580697125 -0.04030696751008246 -0.17888393993528745 -0.2489329837946434 0.08318715265848708 -0.3323474817267076 0.228483724297439 -0.2050725899781806 0.17045877334601817 0.10469331332942201 0.005528369010204412 0.03178442101484437 0.013543469602432766 0.022957322597325577 -0.015561178121795638 0.018944693945044916 0.016572014372263234 -0.05834360076181759 -0.0029205311209574256 -0.03158333686726802 -0.048198562839845936 0.005863505454641342 0.025155991584656368 -0.005718397244553969; 
-0.022864510412516775 0.8807194142393413 -0.020538751350434793 -0.2997806784206005 -0.5220614292540479 -0.51291453923417 -0.10137738541573389 0.2400060670361346 -0.8224869686890331 -0.11033223078300168 -0.9108877894368872 0.2879287111703192 0.6153663263752757 -0.09039692065601954 -0.017222363214557317 -0.10922239028598017 -0.0646141801961154 0.02553334008657341 -0.019120285607043645 0.049492139615050605 -0.0028727823611932194 -0.06868953773390768 -0.08822122530481082 -0.05630887933331357 0.013116248957083028 -0.05925844767150326 -0.05837248484566793 -0.05523007577955481 -0.037924651430292916 -0.02442590721803034 0.06341098797923835 0.007383047418124618 -0.07714533519211884 0.04604913137013182 0.013047118333298174; 
0.09065001928866136 0.40659929630018377 0.6857909865610643 0.4348712077236559 0.12099786534942981 -1.0688617961479905 -0.11172163513744993 0.2133441078530344 0.3617436250580964 -0.27557331127044754 0.31265022632480266 -0.31284549795238664 -0.2469483480686691 0.3415695134698317 0.25258090691153917 -0.24777200832211682 -0.23442469097558713 0.10341672144986902 -0.023693617231239274 0.05257710444579366 0.005065904621725275 0.013431812159011425 0.0023206086276312877 0.03977647461913157 0.08270954222588617 0.03798870811930967 -0.03268574429098989 0.0612244478423761 0.030244073014759416 0.044377839165914694 0.03285508410247277 0.02300449198362088 -0.05055950190739056 0.006247978829866679 -0.009888277836574247; 
-1.0963675957261751 0.6842895238704105 0.26491550948435516 0.7298800341328949 -0.13884544760018827 -0.10875526689047847 0.17124501330350886 0.49807295119291567 -0.21179176221689341 0.3639165756706446 0.09029052364490037 0.16570306068684076 -0.39066382629883406 -0.08098870815837812 -0.006091286094142804 0.06745841145463508 0.06239362005665114 -0.11361326332344615 0.028252910523463393 0.11569006952272012 -0.11784211330869834 0.06529871915208502 0.1194604938417705 0.023201620317720804 -0.05739388519658523 -0.022150250078878938 -0.04538086710067381 -0.08386149961937049 -0.015493020219867613 0.012841595511204605 -0.05176810794143838 0.0005797837225403044 0.023131257761664782 -0.04505504187641026 0.0025130851394497365]

# equating lux wf params to ACESchrodinger's
for i = axes(W1, 1)
   for j = axes(W1, 2)
       ps.hidden1.W[i,j] = W1[i,j]
   end
end

# initialize a common position
# X = (rand(N).-1/2)*L # uniform distribution [-L/2,L/2]
X = [16.696420869098347, -16.767311233738372, 23.18904771996763, 17.11187436418423, -6.802602318898621, 15.628930227790727, -6.038890059385402, -16.96263509839582, 27.530445871777864, 25.649302161655097, -3.244750114594488, 26.518034415016945, -5.227240934745412, 23.01312018781927, -6.842689388024099, 17.184668388527196, 12.533416243470077, 8.465754790516096, 10.962040999676505, 3.32415946547691, -7.998918503102168, 4.5333343982032615, -28.810047919479757, -2.598628485789398, 8.835084985616364, -14.212340670735381, 29.027361525465697, -12.588718780462989, 8.691285091130412, 15.967399089141974]

# test evaluation
wf_ACESchrodinger = -4.6809912090470185 # what ACESchrodinger evaluates with the above X and W
wf_lux = wf_new(X, ps, st)
@test wf_ACESchrodinger ≈ wf_lux[1]

# grad w.r.t X
gradX_ACESchrodinger = [-4.010529479900097, 12.917524842112583, 9.751141751013549, 5.422707764410975, 43.305330470743975, -5.879293442167221, -0.033093548214757185, -7.664453892081503, 0.9027285054135936, -1.5585942426347819, 1.365219137204515, -0.02393416442538271, 2.1281488043040224, -13.09065437020664, -56.31655302403493, 2.041487261092391, 1.481519643310452, -14.742059927049443, 0.7387580406924688, -1.7774160164414177, 0.28370762450403025, 0.9291386812515726, 0.8672183032508328, 0.015098002295711677, 18.436845231741305, -1.8200362734510436, -0.3474816880737304, 0.1521277881968183, -5.754757450358893, -0.8043597757545803]
gradX_lux = gradient(wf_new, X, ps, st)
@test gradX_lux ≈ gradX_ACESchrodinger

# grad w.r.t parameters
grad_params_ACESchrodinger = [-0.2532779949074211 -1.2147027085679127 0.5809067825754823 0.3358009950395058 0.33439286467211105 -0.30951189472580154 0.13448437122315227 0.6463246574144073 -1.093674221010744 -1.2235652438880606 -0.5154867024355667 -0.7417105832897732 -0.9433271093730582 -0.6450062160911898 -0.9254027088616112 -0.920625026361071 -0.18085799383518575 -0.2743904602640532 -0.1897495780740443 -0.15668659476666497 0.5031728515762861 0.6771304056751367 0.5238468680034856 0.0849365502275431 -0.13336615062923707 0.8302348252901424 0.0989005947940701 0.6482163250940628 0.6900405218871659 -0.2745786045696458; 
-1.0512391525460565 0.6858921233404986 -0.4313724859552865 0.03064937745955227 -0.6665712538732192 -0.6277753464012117 -1.3987264484155306 0.11913002811966462 0.5001585099074858 1.6872234978148761 0.3134220623738504 0.8322875245948029 2.4931486367304183 0.7284172093238315 2.085585256246485 -0.14123886371117803 0.010337043562592737 -0.72836804320575 -0.27789032716229384 -0.04538478672487566 -0.2643140531486025 0.6879690448124272 0.8644144616879386 0.32596197089789575 0.15341450909515453 0.8946958152231353 -0.0695425629117505 0.1858127426316383 0.1130038708255935 -0.04265424903907989; 
-1.5824442774703626 -0.44205647276660737 -0.21348282340084332 0.03773733246731131 0.9976682620008464 -0.7212835126808814 -0.8255478537785025 -0.24217570393936788 -0.6072557913068892 1.33689333805843 -0.04193483246058194 -0.5497474287608818 2.220173545362804 1.0682538438456581 1.9391797129333948 0.38371577113696315 0.43419484872117686 0.6467807712687329 0.3654805177830608 -0.163885483727251 0.3220540441228794 -0.21569511140483172 0.06839418426865346 -0.07381604356243152 0.005943014679656725 -0.026562804477462055 0.32680221350333305 -0.05002140837513374 0.3215713489167764 -0.26566731912258285; 
4.841402208343922 1.936349557556523 -0.04352028793722544 -2.006971901974178 -1.265947710418248 2.847559697339113 3.7853517123934175 0.7741596819394745 1.9436196288178533 -5.109328271819153 1.0232813180524103 -0.5399002933204177 -8.981737096792566 -2.449282295915363 -7.544248552187365 0.09332777711293078 0.495863584507364 0.34528630550281975 -0.7361936672421528 0.22125067358867734 -0.2431724872418115 -0.2528832188487728 -0.4168201820652975 0.11901359981621894 0.2450066452737482 -0.18571906817199976 -0.07748273377453556 -0.14208750245533858 0.1038542051117299 0.42384762635301926; 
-1.8902465715441497 -1.5136078417391678 0.17317616940955027 1.081083441569035 0.8729971460893546 -1.0284500320809542 -1.0731627941673143 -0.5773700660238466 -0.8062338652525486 1.1497052099201495 -0.8637419435835559 -0.07738639025650167 3.827120031524275 0.9676801758766765 3.224747644102743 0.2208784184123497 -0.17404302371713673 0.21505766009160296 -0.20878931035015388 -0.399224183963055 0.056744920870530485 0.5490099340458405 0.18606372164867488 0.1404591160814483 -0.008502910166170812 0.7824381930581477 0.27378110386556564 0.06114607009769333 -0.001835540310737948 -0.14205575718106858; 
0.7918994849470832 -0.4692531948459369 -0.4615830402983937 0.10952495943869939 -0.040003195873072946 0.1706117353342244 1.125150809596968 0.1712081723669946 -0.13482385977581615 -1.450331953472648 0.11507067141977732 -0.31834616643370334 -1.9169139311788734 -0.8005855082866106 -1.3619952509830666 -0.019615504420490305 0.635737113257348 -0.007847622997156797 -0.134656679583157 -0.16739013681960208 -0.018532984315710953 -0.13833161498182941 0.3566839886612017 -0.1512187888308211 0.1408911184150706 0.1431096104762853 0.37980845716166456 -0.5321226059205326 -1.020505809835248 -0.24754131300479054; 
1.1940967359404224 0.10855312568883524 0.406739004275018 -0.010134629319712592 0.4063886612591348 0.6934199634447986 1.2596002351045334 -0.23769972949307122 0.11407682430408125 -1.2996219165514125 -0.27158600589950377 -0.06439675701764203 -2.5864832836933256 -1.0608650326321851 -1.8711342933606048 -0.3365300048404694 -0.4615487927889909 0.06255320181214033 -0.4425541846355683 -0.7404241311892004 0.1206473983660232 1.0938715718355199 0.1745655614119859 -0.23747045520195514 0.3449714979326853 0.4278285425348059 0.330621598561066 -0.21769481049572348 -0.5434872717587687 0.057521593305392776; 
-2.963868315554661 -2.021852547479291 0.5404122603663398 1.1176727056876126 1.3972156686083854 -1.8046951361111696 -1.2378847553097108 -0.4163685848827392 -1.3170692483215358 1.2019552644704492 -1.5733186732416051 -0.5085988481386069 4.835651775531415 0.8270258783928016 3.414769072665826 -0.5428208192307257 0.38887326130320926 0.6408101989045938 0.13399515880877186 -0.19945423555061517 0.89294131766947 0.11020964529477557 -0.3663415559161312 -0.5251490447921588 -0.5094585264515935 -0.26196294263912867 0.2294809896556043 0.12332389222037281 -0.790208279817878 -0.2078391829171582; 
-4.328823545895253 1.4033471803680877 -0.8903907615208715 0.8553859178834662 0.39784042317555757 -2.9249386304789935 -4.607984866113315 -0.8836346742580319 0.3398775196312912 8.005149659563282 0.1966732598444891 1.3469657431365698 9.860635483005655 2.390412267314932 7.920555630549256 0.19832946610081162 0.22650493734897312 0.9957937948992625 -0.2695731100970215 -0.16575764327515985 0.9891896438060144 -0.20594589958079215 -0.014998824450544658 -0.33959666494186314 -0.046693286775394874 -1.8558157679860658 1.077512809311702 -0.5535555605779348 -0.6889556316829336 -0.4069498709939429; 
-4.889738901174322 0.0142904793059749 -0.12589249345489573 0.8131072167895228 1.7317285211490057 -2.238651720129669 -3.9224655496717435 -0.556001676945924 -0.7713986861287999 5.353599757140092 -0.4298342770840243 0.731247823484369 8.526436932351734 2.6488962409927197 8.009387263783456 0.6325212885605715 0.5047855224194061 1.039964617896557 0.35830901347438243 -0.02446556631865926 0.38306954332366455 -0.08571433389260581 -0.012195764283625296 -0.2878250592933285 -0.30811557722871563 -1.5005880965186857 0.18289365408949454 0.2963725061921571 -1.003228213591242 -0.12611090940583114; 
5.356543704316824 0.38686725271650896 -0.20996120522180364 -0.6385928756705922 -1.194781126473124 4.055653725678831 4.376749284253403 0.9186836453602036 0.7258820493516593 -6.207526262175957 0.22343536846362397 -0.9059659724569064 -9.819978681450314 -1.7967638137877777 -9.007332036495036 0.06533701415960401 0.11337554363376472 0.15726155673182068 0.08270692412191637 0.26459613012447386 0.8562528193424475 0.22632630152956865 0.02050412133727791 -0.793738290280193 -0.19384744081721755 -0.7048832678439181 0.003550888477513484 -0.3464284197001271 0.0560227981281983 0.1264565166749124; 
-3.2948571924353405 2.418441253089154 -1.2163727498465329 0.7784674547841992 0.12798731912387465 -2.2875213757848645 -4.630534759820787 -0.589640218987131 2.43609523030734 7.4182813876081335 0.8126785515623721 0.9716526440565653 8.286939824215075 0.6767512869542205 6.493237932259776 0.7998050550413326 0.5387399508512433 1.8020072658925645 0.1443372560237485 0.11170837112148459 0.29847920797045147 -1.2006932233945866 -0.5077438695959093 -0.17014163532439894 0.4245795149758501 -2.3438008534932986 0.30556139214311234 0.26829524743865246 -0.2300125108037976 0.02851361418677579; 
-8.770472474920028 -5.009130024479737 1.7372532960511988 3.588964442300646 3.2579698915243407 -5.537913957780107 -6.954663721465395 -0.6909215217240521 -4.588859713482931 7.555973789410698 -2.0665418609623436 -0.27795266362433263 15.622738189951365 4.8007104027403775 14.786270736350296 0.17397419913336568 -0.7359588553809351 -0.6273291152568148 -0.705843792354078 0.38945469204852784 -0.10971391344507957 0.2898053892143723 0.7976772633928217 -0.32442896627484946 -0.5570663601789015 1.1224252840595381 -0.20248860416187403 0.33763980318447046 -0.10005136735860812 -0.23714236462015614; 
16.32900046239669 5.048095615744281 -2.063605560764565 -3.221027155837731 -5.55573166047701 10.070684634763252 12.55735926251541 1.9324114518275708 4.359698968381827 -15.335689908300287 1.8248341256856373 -0.18382304193558782 -28.846593384865468 -7.302701273737389 -25.18620483472983 -0.24410006146949517 -0.7666307339297556 -0.8869284278876114 0.2163418610364606 -0.13240345568780226 0.09954760809542945 0.25710411196672506 0.6338291864169354 0.23037300806434638 0.9209213178937037 1.4567094273652106 -0.1224149159495506 0.036740278565945285 -0.5381201679487327 -0.2914789164928162; 
5.235954195706654 3.4850149934817054 -0.2041254148397624 -2.3276625163823055 -2.342974399709713 2.6095648149511 3.287210948049223 -0.5109655166508297 3.773834980089161 -3.66031619112133 1.7648431297393188 0.4924900145015253 -9.586100866079834 -2.6499457507936115 -8.735269326516871 -0.759144885217186 -0.9758990853683732 -0.7175258370095897 -0.3772776401088571 -0.8115639340986881 -0.2989047272079602 0.7521602667862474 1.1009175981885546 -0.6825576739306791 0.34613451644692605 1.8234656477419648 -0.42438025217715847 0.2886592533155318 -0.38572466278809725 -0.06361874946410732; 
-19.487303039337682 -10.960742955503957 4.162200243060351 7.267946990351972 8.248195225138712 -12.947087213430336 -13.303449013382744 -0.914328994643594 -9.626634480220758 15.86843898361787 -5.971773992726734 -2.089554026133556 34.421660359423726 10.387327594558359 30.439510433679974 -1.3174538644977447 -1.794610720384173 -1.5258491796216183 0.027382350293974855 0.07364386014137207 0.7283640348199455 2.197903726926407 0.3165202943000454 -0.2855872215236512 0.6563647716905677 3.269336963342947 -0.13968941746289862 0.42326960998267427 -1.282131307390119 -0.49903472520738335; 
14.535911700169303 1.8492974075855058 -0.8082466604188121 -3.7919935068179713 -4.199844453497332 7.864563868642175 11.890258603195313 1.8818466937628413 -0.07823764030840794 -15.1124957925357 1.1991751423018362 -0.7391494984199524 -24.95302700735234 -4.604881594914929 -20.849756291762787 0.36099735779296416 0.11576347013141959 1.3396269911378422 0.030380900953726957 -0.6804782204060579 1.2892494270118955 -0.3710492698922902 -0.019287999728861766 0.04817855587229028 0.23121038818594164 -1.401335963772735 0.5425864492293623 -0.15867278723015718 -1.5016802639706512 -0.6117450436271464; 
5.559620231888913 1.7457034073323845 0.011315450835005585 -1.7395317187224908 -1.3182041628683714 4.499599462292418 4.7148092565978965 -0.22916444475513417 3.853028745309815 -8.931745211224625 2.3086206703862753 -1.2877699111361665 -13.709140611002361 -2.183819419259277 -11.153296414403634 0.11117166862176903 -0.6754430148821338 1.2669052500120812 0.3465547358797396 0.44531910763361515 1.1466933873971727 1.0794062314185793 0.4503016454805291 -1.106869215404961 0.28566103863862424 -1.3057406251004986 2.1183049960076845 0.386712815773833 -2.235781740216992 -0.9011982812503694; 
-16.725338171438302 -14.849314344226512 5.16401344609076 7.221806897615093 9.469268580532432 -9.850886858389066 -8.703930075802448 -0.5967781323023674 -9.520100160528266 7.075006117208752 -4.935085354713457 -3.567189710785021 26.172716046605466 6.801053966048546 21.48595222886359 0.9195204049598341 1.0373377271879338 3.2030240528301266 0.8830180614031067 -0.2539311153340921 2.2926787714672354 0.8503769115573165 -0.9455258817351864 -1.0538991797886823 1.1958599477760508 -2.856917378342924 0.8501868597962611 -0.6216453599404526 -3.5715284008941377 -0.8653224897792052; 
15.537648397067565 4.844478789103765 -3.193990791321981 -3.6357988945684334 -5.7593330286765765 6.489538532559184 8.129382492967295 1.6102977505144833 1.6722275589347468 -10.296363506455677 1.1996202275349142 0.8634067341178503 -21.328053573361387 -4.883623363346474 -17.171024394060133 0.6658584736097997 0.3927821531962757 2.389044080473201 0.6527228720998605 0.26029861209612776 1.4564246994550676 -1.7032333094940528 -0.7833962754410764 -0.9318245320503208 -0.6746828997536516 -4.975721100740704 2.4479518862426968 0.5828876432582547 1.3402363258117211 1.1855853231002027; 
3.9717855829743542 8.975428832160903 -2.5100632015944395 -5.019195903994926 -4.943636012512175 4.250197945327403 0.09977199858696824 -2.173849453978651 4.466669868008185 -0.10213561041776821 4.643015555871967 5.078981886765669 -6.8702502092455715 -2.8189629365922624 -5.731702442637833 1.107472945121449 0.22900513009094348 4.425546492828383 0.044924738717485715 0.6782201089670411 2.4633069179419707 0.8038017425578624 1.0454890407517947 -1.6725068438576534 1.1486151482760378 -2.775065389875255 4.026577481677191 0.07761717170232636 -6.000724053758102 -2.547834888284742; 
-8.011349540501481 -15.91736917552656 6.082570688342448 7.353302433419114 9.08140008629209 -5.298106559178899 1.6703247053127066 0.936921811522476 -8.459572388994188 -5.62223810406558 -5.456023804907497 -4.414711969336067 8.025186843209102 2.026767453490277 3.55989098690125 0.19781733896507844 0.2274995954355523 -2.433220948847341 0.5194896677783174 -0.736792961749748 -0.28332331130064164 -2.003059406479883 -2.6463287047448394 1.2057957555790217 -1.8290027190838294 -0.9530734558958466 -1.9196055605682587 0.44834698330260464 6.171709558827738 3.4475229483874195; 
-11.59207910490856 8.125307937419565 -4.281895158089948 -0.6437433573996446 -0.6047351788125721 -8.128939746009676 -16.289071461357075 -2.40702157025777 3.065537829567363 29.324404712127617 0.7448026268139889 7.865556912802422 31.119222074534996 5.405014784363902 24.68127304814915 -2.471234584786351 -2.8181841964259657 -0.029699840888205934 -0.017160343919763652 -0.23787513573297586 2.504396869787314 2.748904896777096 3.054498443875825 -2.343454076186561 0.8344984717779994 2.4668846235283377 3.788185858495781 1.7912072759018933 -2.6437547642730355 0.4458142515229761; 
-10.15221568437117 -0.9387499509962136 2.3402070098076786 -0.047969743742031765 1.7461713093825768 -5.407593045108376 -8.270123655639939 -2.2477529583464206 -7.660781195078129 7.798704230429448 -0.37474904906709805 3.2028842001204967 18.9348569491321 4.719584752254762 16.011909925947915 1.1092189224722613 2.082931422590393 -3.501785092909815 0.17621835796783597 -1.4289706627162513 -3.494938900475972 -1.9863390573594635 -5.20708299323727 2.154635811893299 -1.1849544254930575 1.3409493331519955 -6.023137120059069 -1.2537947828708575 5.664534893027742 0.774174370794052; 
13.161072309084231 -2.018340148660318 3.4917011816831134 -2.8095792265027857 -2.1523297749576726 11.871415478334974 18.778472532907966 2.219594928071438 1.4037638240773034 -24.00773364638682 3.7504823941204535 -4.371233391392438 -33.4948306639239 -9.663011122695448 -30.622853964909705 -2.3772716431832643 -2.6754727913828016 -3.464336642841862 -0.20559290339100214 -0.7110384587623947 3.1717326904026715 1.0453758443836767 -0.32377896203534023 -0.044251505630824486 -1.5900396484462178 1.5012066281860088 0.9667061882827782 3.0279652732804916 3.5626886951984353 3.9669228185950955; 
-23.896829590090114 10.965274349975408 -9.202074365896552 2.3767152419221866 1.3857430679009273 -12.26034908089202 -32.54936286938429 -4.925861603267596 8.398442542132258 49.491016713166616 2.630053131641451 13.668253209744913 56.31668200906772 11.179443125628863 44.812686954832905 3.5609937011979977 4.304599665120575 1.381728537146361 0.1976854747315281 -0.02589632469183572 -6.3432523243638945 -3.4599674962934275 -3.0564738187003897 1.7071286620805954 0.5879998076823649 -1.5598581960532591 -4.356517932481147 -3.9549723138172967 -0.12094820102569422 -5.166553796118549; 
-6.068506252025964 5.234204205954115 -1.6350356620876367 -2.8789395264593742 -3.343130781374565 -3.0772870578108207 -10.189366188423172 -1.9018798118214986 -0.8342865250476565 16.536881596081678 0.2726809306219215 2.320506447643282 16.799649127335005 4.826308716482217 18.452761359034415 1.9648318593843377 4.419920365132645 0.4862598623110827 1.3290977007301314 -1.7826169797126277 1.6861741002584516 -3.044085835584655 -8.41766500178552 0.056690253333799775 -0.8702157704748259 -7.967289097086683 -3.3824776555427194 0.6478714902126355 5.2567951705665825 2.475241813840757; 
23.17737444733221 8.598443594784866 2.2625339314566566 -9.460440337453477 -9.757042301084601 17.02402373107492 23.434084773943646 0.8062744616815808 4.365979731513413 -27.241248873943363 9.150550039522674 -0.5445992377750535 -48.3982442227486 -16.170810378893048 -43.157586430294536 0.7440184999386369 -1.4320409463934562 -0.4123014243008921 -0.20690347371785886 3.0549305649406344 -6.87280287658283 -0.701314965907655 5.8492015722191635 2.127642067934823 0.4812533385212978 4.704980374983592 -1.3425139253019471 -3.5501780419537514 -0.8794420160382442 -3.254318044169538; 
-0.7591725155854336 11.568333370947862 -5.437369022389282 -4.383827973800825 -3.9424788995398066 2.6904078106287925 -3.9606690383805714 -3.3572039771334214 16.319562906604773 11.71925972203519 5.777831877868497 2.672972255832453 -3.100957908510205 1.057348348356039 0.42189110656045486 7.579294896503703 10.820169125643654 7.2604073296874905 1.430051886052131 -0.7333056258664836 -3.0866750496102164 -8.487045273128476 -10.602761152868245 0.8803073626750586 0.42626808704800817 -14.91569736217929 -3.6014963103197277 -3.56911660450239 0.4349110805415896 -5.843170905194112; 
-5.177106270017327 1.2871270231512093 0.7453396979352059 -2.5003477969959 -1.8070006803058252 -2.7085485142129926 -5.6462581980799476 -1.1787738462860295 -2.682400898159888 17.95809607048295 -2.4386217999176054 2.4875771093704198 16.178829697929842 5.5802514945559905 15.243131221686424 -6.71005450733092 -12.894063874904354 -10.761874470243368 -1.9442037480715482 4.651550258254244 -4.286691465694625 6.339766225075912 15.067383728549055 3.4826207240427918 -1.713194697867486 19.697143236542423 0.23329076222566822 1.0709336494318074 4.243037881175286 6.212695976196204; 
44.944657615503466 0.6126047169620064 7.090474132633311 -12.612074477566766 -11.39089651628358 22.413695171889312 46.22566059177119 5.881173395623206 -2.10109764719173 -62.95344215834112 2.719551812352487 -15.592174929987031 -90.10232211912043 -20.122977167872396 -70.60984598995252 2.476469224281486 3.3306272455963537 -0.7114597370938336 0.5099898515792121 1.6032726214413489 -9.928799681181184 -3.1111367851581146 0.03832698533236425 2.781592974121755 0.8399779396399113 3.5386141110647933 -5.815665291521115 -4.950442917514612 0.5855521211405729 -5.602061622351598; 
3.3085963147079864 8.22871714041692 -1.0341623793545536 -8.635765380975059 -5.3660004964256025 9.280793254693732 4.908144854238587 -4.376420062085134 13.115168356447668 -1.8972380013181598 9.437418895590028 -2.037337706946215 -20.017730591037814 -0.5737949401096757 -10.303906954640366 -8.92693196115633 -13.554809736885462 -11.541617817831895 -2.428000878748199 1.2374181513315727 2.1401500085208136 8.421418748686355 11.891543997742513 0.7939749725454872 -1.5301871648272485 17.828304219855614 2.915640151263002 4.976895821305792 4.626144115287666 9.680415079020177; 
11.535721207803823 -18.852047793789286 -0.6874686126452397 9.198843479643328 7.026338369059458 4.893500575531674 14.752097077803038 7.08293030482466 -1.3534513303861284 -23.815974074453976 -10.63537773590281 -10.086989504042135 -22.599791402560626 0.6046383613595465 -18.505233032984318 -7.07156016229616 -13.346725950553035 -16.366729223635165 -2.608706588754881 5.574165880361795 -13.07374847699708 5.662914921459018 16.729694263966802 7.446304500066069 -2.4503355883437594 29.68503033392985 -5.408466559985656 -1.4890654376831909 6.812656916333942 4.044889729101281; 
43.88952092694819 14.733313574406216 0.4696596955148654 -20.271280773417452 -18.954606592112675 23.29564933429065 34.628952300574966 0.8818500833396375 8.64160691766112 -43.47034769739871 9.248819982963882 -10.894536905693004 -82.5059830004525 -17.731500350976077 -58.884014716865636 0.48108218709217104 4.130867840965274 6.651522417215425 0.18184759848448298 -4.866961988004965 11.398426509672484 -0.09787954935747269 -7.963542441650606 -5.5892230246315275 1.1971556123659182 -12.990416559552854 6.463791000561944 4.143418536637161 -3.7531490719254883 0.3489402438681884; 
-19.208298841215118 -15.238816036395601 8.732401307573408 8.531666748687522 11.58211042704496 -14.783248755876933 -7.942006061697909 -0.8837956260024606 -14.58696532214286 -8.76999452230236 -4.965073460113832 -8.704282001667371 21.288400278436566 4.81801115432659 20.920029133510386 -11.826652731597813 -19.628258614739185 -19.34318419875022 -3.119096406069539 5.254869369408376 -8.102698192006338 9.127638611138615 21.251868071042793 6.1105443170836615 -2.9817737443101673 32.014433389493064 -1.0968818830088414 2.5872868551816675 10.7149136389562 12.794216410740678]
gradp_lux = grad_params(wf_new, X, ps, st)
gradp_lux.hidden1.W 
@test gradp_lux.hidden1.W ≈ grad_params_ACESchrodinger'

# Laplacian
laplacian_ACESchrodinger = -3138.299531992434   # what ACESchrodinger evaluates with the above X and W
laplacian_lux = laplacian(wf_new, X, ps, st)
@test laplacian_ACESchrodinger ≈ laplacian_lux
@show abs(laplacian_ACESchrodinger-laplacian_lux)

## Rayleigh Quotient test. Sampling is more costly so we will work with smaller model
## Here we need the potentials and sampler
function v_ewald(x::AbstractFloat, b::Real, L::Real, M::Integer, K::Integer)

   erfox(y) = (erf(y) - 2 / sqrt(pi) * y) / (y + eps(y)) + 2 / sqrt(pi)
   f1(m) = (y = abs(x - m * L) / (2 * b); (sqrt(π) * erfcx(y) - erfox(y)) / (2 * b))
   f2(n) = (G = 2 * π / L; expint((b * G * n)^2) * cos(G * n * x))

   return sum(f1, -M:M) + sum(f2, 1:K) * 2 / L
end
b = 1 # harmonic trap strength (the larger the "flatter") or simply "width"
M = 500 # real space sum
K = 50 # reciprocal space sum
vb(x) = v_ewald(x, b, L, M, K)
V(X::AbstractVector) = sum(vb(X[i]-X[j]) for i = 1:length(X)-1 for j = i+1:length(X));
# Mdelung energy
Mad = (Nel / 2) * (vb(0.0) - sqrt(pi) / (2 * b))

# Hamiltonian
Kin(wf, X::AbstractVector, ps, st) = -0.5 * laplacian(wf, X, ps, st)
Vext(wf, X::AbstractVector, ps, st) = 0.0
Vee(wf, X::AbstractVector, ps, st) = V(X) + Mad
ham = SumH(Kin, Vext, Vee)

# define lattice pts for sampler_restart
spacing = L / Nel
x0 = -L / 2 + spacing / 2
Lattice = [x0 + (k - 1) * spacing for k = 1:Nel]
# @show Lattice;
d = d1_lattice(Lattice)

# setting up sampler
burnin = 2000 # actually not needed
N_chain = 50 # the data is with N_chain = 50

# self-defined sample
# x0 = (rand(Nel, N_chain).-1/2)*L 
# x0 = [x0[:,j] for j = 1:N_chain] # sample is a Vector(Vector(Float))

sam = MHSampler(wf_new, Nel; Δt = 0.5*L, burnin = burnin, nchains = N_chain, d = d, lag = 0) # lag = 0 so that it doesn't try to sample from wf. We can probably set burnin to 0 but since it is not called once x0 ≠ ∅

## Energy (We will explicitly import to appraise)
eval(wf, X::AbstractVector, ps, st) = wf(X, ps, st)[1]

function sampler(sam::MHSampler, ps, st; batch_size = 1)
    if isempty(sam.x0)
        r0, Ψx0, = sampler_restart(sam, ps, st; batch_size = batch_size);
    else
        r0 = sam.x0
        Ψx0 = eval.(Ref(sam.Ψ), r0, Ref(ps), Ref(st))
    end
    acc = []
    for i = 1:sam.lag
        r0, Ψx0, a = MHstep(r0, Ψx0, sam.Nel, sam, ps, st);
        push!(acc, a)
    end
    return r0, Ψx0, acc
end

function Eloc_Exp_TV_clip(wf, ps, st,
                sam::MHSampler, 
                ham::SumH;
                clip = 20., batch_size = 1) # change clipping (5 -> 20) to see what happens
    x, ~, acc = sampler(sam, ps, st; batch_size = batch_size)
    raw_data = pmap(x; batch_size = batch_size) do d
        Elocal(ham, wf, d, ps, st)
    end
    Eloc = vcat(raw_data)
    val = sum(Eloc) / length(Eloc)
    var = sqrt(sum((Eloc .-val).^2)/(length(Eloc)*(length(Eloc) -1)))
    ΔE = Eloc .- median( Eloc )
    a = clip * mean( abs.(ΔE) )
    ind = findall(x -> abs(x) > a, ΔE)
    ΔE[ind] = (a * sign.(ΔE) .* (1 .+ log.((1 .+(abs.(ΔE)/a).^2)/2)))[ind]
    E_clip = median(Eloc) .+ ΔE
    return val, var, E_clip, x, acc
end

# Note 10/11/2023
x0_1 = load("ACEpsi.jl/test/1d/sample_x0_1.jld")
x0_1 = x0_1["x0"]
sam.x0 = x0_1 # lag = 0 so that it doesn't try to sample from wf. We can probably set burnin to 0 but since it is not called once x0 ≠ ∅
λ_ACESch1, var_ACESch1, E_clip_ACESch1 = 7.47458766426806, 2.6323378037977325, [2.1618802507206, 2.539556840287787, 9.779536524153713, 1.9544453626990617, 6.903631959939958, 6.949208074969334, 6.581413659926966, 2.042026383396575, 11.789037332420548, 8.192285001297137, 7.257497112764838, -2.154708725263646, 131.7008100385741, 5.769394496888779, 8.19447701524803, 6.092228895306448, 5.998447347260935, 4.583024375683124, 1.8562939155652174, 2.8280492922474423, 7.5422102257958485, -1.6906594359007983, -1.3299195333079865, 2.2357807066629505, -2.9523403880284604, -2.854894977926449, 4.001954116772218, 5.886351855663065, 6.540064613059769, 9.90796503771071, 11.053788376292204, 19.766529455350337, -1.2118809209156183, 11.650623523274703, 0.198276725015603, -5.477387796405161, 3.36631099688595, 16.84954673685047, -1.3134038579131868, 5.458839116930449, 8.753341278736173, 3.0161377970706553, 4.6349330663788635, 14.113189961225942, 6.746926540874256, 2.6662934290068208, 4.862579521260159, 2.42600645039235, 4.204903158324669, 3.6587726959664906]
λ1, var1, E_clip1, x, acc = Eloc_Exp_TV_clip(wf_new, ps, st, sam, ham)
# @test λ1 ≈ λ_ACESch1 # test did not pass
# @test var1 ≈ var_ACESch1
# @test E_clip1 ≈ E_clip_ACESch1
@show norm(λ1-λ_ACESch1,Inf)
@show norm(var1-var_ACESch1,Inf)
@show norm(E_clip1-E_clip_ACESch1,Inf)


x0_2 = load("ACEpsi.jl/test/1d/sample_x0_2.jld")
x0_2 = x0_2["x0"]
sam.x0 = x0_2
λ_ACESch2, var_ACESch2, E_clip_ACESch2 = 12.065412818179192, 7.281720909321554, [1.962083273760527, 5.243425359858602, -4.010705156286463, -1.2159998736742352, 10.029057595901818, 8.673184997140623, -0.9560932074691664, 6.426268135466714, -4.043103856825809, 5.950694509129164, 8.999572804527915, 7.060524063141202, 28.697708316328317, -19.301066993117345, 13.618078903414016, 3.4521967979633814, 2.0561496628087124, 5.199910344206728, 2.2997316175503215, 20.028623948981476, 7.2098551686231716, 0.10772982272632703, 12.459031390834625, -4.353215304599317, 5.714441139217158, 2.636097937560649, 13.738202278567194, 6.397926756468564, 8.153292711632247, 3.4318303230159968, 0.4980070332732751, 4.572388327427092, 11.742240823127034, 5.253134912780297, 6.152111719556842, 0.7566568499835142, -5.79387381059793, 6.50424795624042, 15.02493011119077, 0.5545338882105284, 3.286197885803631, 7.9768257759966446, 3.431859434368903, -0.6947080161753263, 362.24604856003464, 0.33402981224074324, 16.23842171012447, 2.82954428491189, -0.21192203460780945, 3.8680655830822275]
λ2, var2, E_clip2, x, acc = Eloc_Exp_TV_clip(wf_new, ps, st, sam, ham)
@show norm(λ2-λ_ACESch2,Inf)
@show norm(var2-var_ACESch2,Inf)
@show norm(E_clip2-E_clip_ACESch2,Inf)

x0_3 = load("ACEpsi.jl/test/1d/sample_x0_3.jld")
x0_3 = x0_3["x0"]
sam.x0 = x0_3
λ_ACESch3, var_ACESch3, E_clip_ACESch3 = 4.661951353071479, 1.7997091799680722, [18.855533886289777, 8.964234750646938, 1.5207695385979605, 0.016059748471207058, 33.3393542773988, 9.942079221284132, 8.295070983872677, 11.186295689603867, 18.2543577150268, 8.747828313684295, -5.809366342589556, 6.200914879333439, 1.139465093612671, 4.222079133423165, -10.329537378168638, 12.094992539317502, -39.87572776193633, 10.689447675595659, 11.212572656547884, 4.619556282491658, 0.24681684611186938, 14.060774069006584, -36.08857876567504, 11.31832417473214, 9.684605686229446, -2.7224543116945057, 5.010720298074659, 7.68038730535045, 14.235018314939396, -1.6089309455586154, -12.664408915463355, 14.746538771297281, 2.699041382464202, 4.450197046828805, -0.8052327883821278, 1.3701185732497265, 7.468519378337078, 1.931918774281229, 9.526109960556823, 6.40369097241404, 18.020225533846883, 30.316821470788454, 0.5143982826448337, 3.863422090340464, 4.819178455512883, 1.8249757383884742, 9.677378229713284, 12.058222183336625, 2.417823539105143, -20.644034599707084]
λ3, var3, E_clip3, x, acc = Eloc_Exp_TV_clip(wf_new, ps, st, sam, ham)
@show norm(λ3-λ_ACESch3,Inf)
@show norm(var3-var_ACESch3,Inf)
@show norm(E_clip3-E_clip_ACESch3,Inf)

## eparate test for local energy
"""On the H8_test branch of ACESchrodinger, Jul26 had a commit that modifies the returned values of "sampler" from "R, r0, acc" to "r0, Ψ0, acc."
I agree that the modification is correct
"""
# function Elocal(H::SumH, wf, X::AbstractVector, ps, st)
#     gra = gradient(wf, X, ps, st)
#     val = H.Vext(wf, X, ps, st) + H.Vee(wf, X, ps, st) - 1/4 * laplacian(wf, X, ps, st) - 1/8 * gra' * gra
#     return val
# end
Eloc1_ACESch = [2.1618802507206, 2.539556840287787, 9.779536524153713, 1.9544453626990617, 6.903631959939958, 6.949208074969334, 6.581413659926966, 2.042026383396575, 11.789037332420548, 8.192285001297137, 7.257497112764838, -2.154708725263646, 131.7008196227871, 5.769394496888779, 8.19447701524803, 6.092228895306448, 5.998447347260935, 4.583024375683124, 1.8562939155652174, 2.8280492922474423, 7.5422102257958485, -1.6906594359007983, -1.3299195333079865, 2.2357807066629505, -2.9523403880284604, -2.854894977926449, 4.001954116772218, 5.886351855663065, 6.540064613059769, 9.90796503771071, 11.053788376292204, 19.766529455350337, -1.2118809209156183, 11.650623523274703, 0.198276725015603, -5.477387796405161, 3.36631099688595, 16.84954673685047, -1.3134038579131868, 5.458839116930449, 8.753341278736173, 3.0161377970706553, 4.6349330663788635, 14.113189961225942, 6.746926540874256, 2.6662934290068208, 4.862579521260159, 2.42600645039235, 4.204903158324669, 3.6587726959664906]
Eloc1 = Elocal.(Ref(ham), Ref(wf_new), x0_1, Ref(ps), Ref(st))
@show norm(Eloc1_ACESch-Eloc1, Inf)

Eloc2_ACESch = [1.962083273760527, 5.243425359858602, -4.010705156286463, -1.2159998736742352, 10.029057595901818, 8.673184997140623, -0.9560932074691664, 6.426268135466714, -4.043103856825809, 5.950694509129164, 8.999572804527915, 7.060524063141202, 28.697708316328317, -19.301066993117345, 13.618078903414016, 3.4521967979633814, 2.0561496628087124, 5.199910344206728, 2.2997316175503215, 20.028623948981476, 7.2098551686231716, 0.10772982272632703, 12.459031390834625, -4.353215304599317, 5.714441139217158, 2.636097937560649, 13.738202278567194, 6.397926756468564, 8.153292711632247, 3.4318303230159968, 0.4980070332732751, 4.572388327427092, 11.742240823127034, 5.253134912780297, 6.152111719556842, 0.7566568499835142, -5.79387381059793, 6.50424795624042, 15.02493011119077, 0.5545338882105284, 3.286197885803631, 7.9768257759966446, 3.431859434368903, -0.6947080161753263, 365.28251519516925, 0.33402981224074324, 16.23842171012447, 2.82954428491189, -0.21192203460780945, 3.8680655830822275]
Eloc2 = Elocal.(Ref(ham), Ref(wf_new), x0_2, Ref(ps), Ref(st))
@show norm(Eloc2_ACESch-Eloc2, Inf)

Eloc3_ACESch = [18.855533886289777, 8.964234750646938, 1.5207695385979605, 0.016059748471207058, 33.3393542773988, 9.942079221284132, 8.295070983872677, 11.186295689603867, 18.2543577150268, 8.747828313684295, -5.809366342589556, 6.200914879333439, 1.139465093612671, 4.222079133423165, -10.329537378168638, 12.094992539317502, -39.87572776193633, 10.689447675595659, 11.212572656547884, 4.619556282491658, 0.24681684611186938, 14.060774069006584, -36.08857876567504, 11.31832417473214, 9.684605686229446, -2.7224543116945057, 5.010720298074659, 7.68038730535045, 14.235018314939396, -1.6089309455586154, -12.664408915463355, 14.746538771297281, 2.699041382464202, 4.450197046828805, -0.8052327883821278, 1.3701185732497265, 7.468519378337078, 1.931918774281229, 9.526109960556823, 6.40369097241404, 18.020225533846883, 30.316821470788454, 0.5143982826448337, 3.863422090340464, 4.819178455512883, 1.8249757383884742, 9.677378229713284, 12.058222183336625, 2.417823539105143, -20.644034599707084]
Eloc3 = Elocal.(Ref(ham), Ref(wf_new), x0_3, Ref(ps), Ref(st))
@show norm(Eloc3_ACESch-Eloc3, Inf)

## separate test for ee-interaction
Vee1_ACESch = [-3.9167101721368396, -3.0269681884234956, 0.18275279746328188, -2.5084680343669525, -1.1945627127309657, -1.364637668143741, -1.2729187260556012, -2.2248940392742114, -2.1397405500621405, -5.126623022074749, -1.9139459325011854, -5.091273767942598, 3.4466641652537713, -1.7590185318432103, -5.803584324776084, -0.702716723852129, -2.317296840429482, -1.1643316020840264, -5.051706296583259, -1.7395861445003657, -1.7284333183510285, -5.476602264002622, -6.293630394862781, -2.465036830570475, -2.9821550536489463, -5.731942591910562, -3.309117818111419, -2.34673575418113, 1.5734783205155738, -2.1326546275376086, 1.6291165647560373, 3.869998799962008, -1.139010828628363, -1.550396189980614, -3.3264248560806333, -5.6537931815883855, -4.221418699068912, 4.110146439974017, -5.372523422476929, -3.8720616074514487, 0.6428888179143217, -4.121363314896145, -1.7115696136537686, 2.882366397396653, 0.8440575621267188, -2.158624142186556, -5.010165737221822, -4.033111270270682, -5.0140865517247395, -3.3429999650775564]
Vee1 = ham.Vee.(Ref(wf_new), x0_1, Ref(ps), Ref(st))
@show norm(Vee1_ACESch-Vee1, Inf)
@test Vee1_ACESch ≈ Vee1

Vee2_ACESch = [-2.9728866193771637, -3.0651572027708993, -4.09486092003627, -6.032018849991639, -5.334796609021373, -2.9227147527487007, -2.2107870600095874, 0.06497330048551264, -5.101882149802872, 0.9765975684696024, 2.469223518846349, 0.5184396629783534, -3.7006743825567496, -5.627233101556815, -4.1206382315309265, 0.5874489269555321, -4.5498611419856925, -1.497200922201785, -4.03654716148808, -0.8626367927781464, -1.2824072521439784, -3.163803497352836, 4.522329888883709, -3.3020804986609082, -5.087527879677669, 0.004149373087229513, 5.691515747579116, -1.4499882044867647, -5.942322612333836, -3.3445526443218085, -3.359945979402284, 1.371447222221415, -0.768305639231178, -2.2534593586514973, 0.32664438187330047, -4.016835934294051, -5.710377462574938, 0.7665981663684196, 4.0759984109400165, -3.3320424917558817, -3.407643469073197, 2.4514709624802253, -3.8553073459048672, -5.305521256579253, -3.2647244663444264, -4.737778244960294, 0.4118159960916059, -2.7680285859307565, -4.686670280113129, -3.416202477200372]
Vee2 = ham.Vee.(Ref(wf_new), x0_2, Ref(ps), Ref(st))
@show norm(Vee2_ACESch-Vee2, Inf)
@test Vee2_ACESch ≈ Vee2

Vee3_ACESch = [-3.7704200854672725, -0.6122385038593612, -3.76727581857806, -5.319040285231933, -7.2253816825880115, -1.0176083032018584, -1.643096154960019, -3.4806741841692954, 0.8943825177622289, -2.880172483380682, 0.3448020245095842, -3.7337489669836543, -4.999098834149947, 0.6501624690984888, -6.527539202074191, -0.6551304386783761, -1.0305438202679782, 1.8277384262746357, 2.7040735175232506, -2.3197149736281526, -4.116704977274466, 2.3032016277787526, -4.830346897590402, 3.577639282727367, -0.6535044174771669, -6.539639871463862, -3.6368231557319532, -1.114215328978199, 2.4766740847160267, -5.522930072088294, -6.7477330187906475, -5.506679202369717, -4.400221697756736, -2.7943728030613606, -5.4863774520923805, -4.791190287584956, -1.874675736683855, -5.513390013390514, 0.9321888806218048, -1.5577415708767601, 1.0155741335250292, 0.27393508064937233, 0.048204747468441056, -4.23878545982264, -1.9575492373741687, -2.9878740841597393, 1.9541615498069174, 1.8524763717889123, -2.694966149009332, -3.061490022121127]
Vee3 = ham.Vee.(Ref(wf_new), x0_3, Ref(ps), Ref(st))
@show norm(Vee3_ACESch-Vee3, Inf)
@test Vee3_ACESch ≈ Vee3

""" apparently, the problem is NOT in ee interaction (I thought Ewald summation caused the discrepancy in Elocal)
"""
## separate test for 1/4-term (i.e laplacian) in Elocal  on samples
lap1_ACESch = [-674.0665285289454, -6859.285175579868, -841.9303420097137, -8336.7577492271, -274214.5909271459, -292.1951532270829, -1914.3523512144448, -499.7342082496528, -5561.74817502475, -3845.4290807613024, -249.4795930911318, -832.8447901917614, -79331.36875982887, -370.94863291657407, -140.49113069874366, -2366.799515739744, -12032.53686278009, -1409.005468735987, -92.83113471935347, -3528.551063692722, -129.51158344313993, -381.3138945044136, -1139.2359016385524, -137.66634737277732, -304.2910406575338, -283.5347855968814, -163.7077416313535, -1797.562118350578, -319.0868889570883, -28507.647048852083, -344.3132508262003, -9231.73971180661, -383.555220246479, -2526.2925595307556, -2.1334139316018913e6, -134.04643879206276, -223.19504606199558, -3176.8678150589953, -162.76155671605966, -10094.272746088718, -1189.1446141404174, -1639.31661574821, -430.959812552744, -1122.2727599590762, -1056.7768868227263, -196.74648455205562, -3577.6900252607034, -1003.5080454150528, -4924.903182930273, -339.76240698963926]
lap1 = laplacian.(Ref(wf_new), x0_1, Ref(ps), Ref(st))
@show norm(lap1_ACESch-lap1, Inf)

lap2_ACESch = [-272.10677823806816, -91.31211651318021, -1207.0520619290173, -446.9768026505984, -278.33812725727364, -985.6444150820525, -59067.15577348589, -356.9249991851889, -205.16785211640922, -1652.9678059932662, -187.2547701639437, -1744.8310439278223, -11786.68479920758, -465.17581091012124, -5069.685854268073, -383.1620017677833, -83.72519549815465, -589519.9446412638, -1516.1670193939608, -55288.69764464598, -245.8270386079637, -1036.6123240709262, -465.7890291762952, -209.16536140612487, -143.89096550502998, -349.9308952720072, -125.8925157437185, -269.1686456585908, -211.90483429328512, -55.965319006905396, -227.28289506131168, -560.7076092226775, -546.9559440984724, -53920.942247971565, -177.1734271370228, -165.9235439606646, -183.6019576166684, -2851.373688801165, -137230.58292867214, -1804.695958306802, -5634.875788718571, -3007.139750913587, -986.285537461696, -220.38447705228435, -909204.6104702862, -251.66342615761175, -1059.8462046776888, -5770.851821933461, -86.23229652287722, -605.1397056857087]
lap2 = laplacian.(Ref(wf_new), x0_2, Ref(ps), Ref(st))
@show norm(lap2_ACESch-lap2, Inf)

lap3_ACESch = [-126969.5144698758, -27247.26975070118, -22052.65337473142, -6437.52605328505, -4626.576186870801, -674.4749327198778, -418.34581176641, -59601.85560241615, -3536.8075371799273, -83193.92986709745, -2971.4163477934076, -410.3018595036249, -5.538161052224012e9, -1025.720480475325, -445.23395156736836, -364.95380247060285, -1654.3416277125289, -2012.3604933209506, -275.10379640477146, -2707.4546152085522, -2902.1945752777765, -72340.98306848669, -7696.241612832321, -1426.8462833131202, -862.6096390091678, -146.79984486700397, -1542.56368846348, -129112.76348661768, -1353.3052081878877, -107.28362069214792, -10041.573309082254, -698.0365765735212, -3810.1723742595873, -253.52712526658954, -211.12415548560838, -1715.0731869211413, -1.5780413870844082e6, -625.7534791602222, -30297.07253254314, -913.9966928713537, -716.8737405978046, -1639.0650714060293, -11102.76244896724, -205168.39569491352, -106292.45969205014, -599.0115626882549, -269.3637801417831, -2341.345336097802, -2117.4352831252195, -78281.12796375607]
lap3 = laplacian.(Ref(wf_new), x0_3, Ref(ps), Ref(st))
@show norm(lap3_ACESch-lap3, Inf)
# lap3_ACESch ≈ lap3
# @show x0_3;

## separate test for 1/8-term (i.e gradient squared) on samples
function gra_squared(wf, X, ps, st)
    gra = gradient(wf, X, ps, st)
    return gra' * gra
end
grasq1_ACESch = [1299.5043336750311, 13674.038150930046, 1607.086414205904, 16637.81219127767, 548364.3962969105, 517.8795405092612, 3765.870043341029, 965.3330531179392, 11012.066126989637, 7584.306897335629, 425.5876418201354, 1642.1970600420912, 157636.70427599747, 681.6699616032922, 168.99777067729443, 4679.239466526219, 23998.547772058657, 2772.032089649837, 130.39826774151913, 7020.561043891462, 184.85801853310483, 732.3402463840126, 2238.7621163846666, 237.72615444768724, 608.3435639901037, 544.0531902818899, 268.92690778363794, 3529.2595358224025, 598.4410875738231, 56918.96914038218, 613.2291271601113, 18336.307178370113, 767.6934012312561, 4946.976961355469, 4.266799665591134e6, 266.68163450265973, 385.68825455635226, 6251.8204277429795, 293.05015691560936, 20113.89828638238, 2313.40560859426, 3221.533222600686, 811.1476036652269, 2154.698931407518, 2066.330821815472, 354.89362853456424, 7076.398088453551, 1955.3431490648013, 9776.054448180152, 623.5106326909262]
grasq1 = gra_squared.(Ref(wf_new), x0_1, Ref(ps), Ref(st))
@show norm(grasq1_ACESch-grasq1, Inf)

grasq2_ACESch = [504.7337973310348, 116.15557252532443, 2413.430877748036, 855.4254534906576, 433.7654208751618, 1878.5216321649905, 118124.27399615145, 662.9596396905282, 401.8654778890019, 3266.142836461256, 322.2667460424349, 3437.325412654342, 23314.18253682408, 1039.7422929527268, 9997.461971456587, 743.4060205675038, 114.60230455795404, 1.1789863123923964e6, 2981.643808555614, 110410.26520335789, 423.7159778497902, 2047.0523815812192, 868.084446336983, 426.73980125975703, 201.36617885890135, 678.8062020282271, 187.41153923953237, 475.55397162953886, 311.0447459948416, 57.71957427510835, 423.7021660212189, 1095.8076896037096, 993.827516498079, 107781.83174177168, 307.74311557257727, 293.6591456471087, 367.8718860175207, 5656.846179283354, 274373.57440374227, 3578.2993055738725, 11216.200846598127, 5970.076663319042, 1914.2737406812018, 403.8824481813373, 1.8154608430232804e6, 462.7523878576152, 1993.0795636431146, 11496.92306090018, 136.6666070817119, 1152.0052668891567]
grasq2 = gra_squared.(Ref(wf_new), x0_2, Ref(ps), Ref(st))
@show norm(grasq2_ACESch-grasq2, Inf)

grasq3_ACESch = [253758.02130797753, 54417.927715366306, 44063.00238660543, 12832.371306300474, 8928.634486061708, 1261.2723652438676, 757.1862864221584, 119086.37544584212, 6934.735272781738, 166294.8357278184, 5992.066042523608, 741.126408236713, 1.1076322055339514e10, 2022.8656276360525, 920.8838885434923, 627.9066211172387, 3619.4447269584048, 3953.827312647333, 482.1395996973459, 5359.395060368146, 5769.480975968462, 144587.90555744356, 15642.54908060932, 2791.7670874902024, 1642.5143971886828, 263.0622052558531, 3015.947029296507, 258155.17015216075, 2612.5436625339885, 183.25524837205842, 20130.48002533789, 1234.0474093577063, 7563.550643877407, 449.0976917340578, 384.7991536615348, 3380.855902955605, 3.156008028607896e6, 1191.9444880190706, 60525.3936964468, 1764.301925396381, 1297.7102699930344, 3037.787051690946, 22201.795349653068, 410271.97372942575, 212530.70556255718, 1159.5203267961242, 476.9418268443152, 4601.0447057032225, 4193.968248745523, 156702.9162841328]
grasq3 = gra_squared.(Ref(wf_new), x0_3, Ref(ps), Ref(st))
@show norm(grasq3_ACESch-grasq3, Inf)

## TODO
## test for grad (i.e gradp ⟨Ψ|H|Ψ⟩/⟨Ψ|Ψ⟩ )
# grad(Ref(wf_new), x0_1, ps, st, E_clip1)